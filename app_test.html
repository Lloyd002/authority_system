<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Submission Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
     :root {
      --primary: #6c5ce7;
      --secondary: #a29bfe;
      --accent: #fd79a8;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #00b894;
      --danger: #d63031;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .form-header {
  background: white;
  color: black;
  padding: 20px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  border-bottom: 1px solid #e0e0e0;
  text-align: center;
}


    .form-header {
      background: white;
      color: black;
      padding: 20px;
      position: relative;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
    }

    .header-logo {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 60px;
  height: 60px;
}

.header-text {
  width: 100%;
}


    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

  .header-text {
  flex-grow: 1;
  text-align: center;
  margin: 0 100px; /* Balance the logo space on both sides */
}

.form-container {
  width: 100%;
  max-width: 95vw; /* Changed from 2300px */
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  animation: fadeIn 0.5s ease-in-out;
  margin: 0 auto;
}

.form-header h2 {
  font-size: 28px;
  margin-bottom: 5px;
  color: black;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

    .form-header p {
      color: black;
      font-size: 16px;
    }

    .header-logo {
  position: absolute;
  left: 20px;
  top: 20px; /* Changed from top: 50% */
  width: 60px;
  height: 60px;
  /* Remove transform: translateY(-50%) */
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.header-text {
  flex-grow: 1;
  text-align: center;
  margin: 0 100px; /* Balance the logo space on both sides */
}

    .form-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
      background-color: #f8f9fa;
    }


    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
      outline: none;
      background-color: white;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .data-table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .data-table {
      width: 100%;
      min-width: 2000px;
      table-layout: auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    .data-table th, .data-table td {
      padding: 12px;
      border: 1px solid #ddd;
      vertical-align: top;
    }

    .data-table th {
      position: sticky;
      top: 0;
      background-color: var(--primary);
      color: white;
      font-size: 15px;
      z-index: 2;
    }

    .data-table td {
      background-color: #fff;
      font-size: 14px;
      white-space: nowrap;
    }

    .data-table input,
    .data-table select,
    .data-table textarea {
      width: 100%;
      font-size: 14px;
      padding: 8px;
    }
    
    .button-container {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
    .submit-btn {
      width: 100%;
      background: linear-gradient(to right, var(--success), #55efc4);
      color: white;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      transition: transform 0.2s, color 0.2s;
    }

    .icon-btn:hover {
      color: var(--accent);
      transform: scale(1.2);
    }

    .radio-group {
      display: flex;
      gap: 10px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .data-table textarea {
      min-height: 60px;
    }
    
    textarea[name="authorityRemarks"], textarea[name="actionRemark"] {
      min-height: 140px;
    }

    .days-difference {
      background-color: #f0f0f0;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* New styles for the two-row header */
    .header-row-1 th {
      border-bottom: none;
    }
    
    .header-row-2 th {
      border-top: none;
      padding-top: 0;
    }
    
    .header-row-2 th span {
      display: block;
      font-size: 12px;
      font-weight: normal;
      margin-top: 5px;
    }
    
    .colspan-5 {
      width: 500px;
    }

    .update-btn-container {
  position: absolute;
  top: 20px;
  right: 20px;
}

.update-btn {
  background: linear-gradient(to right, #64b43f, #64b43f);
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.update-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Chatbot styles */
#chatbotContainer {
  transition: all 0.3s ease;
}

#chatbotMessages {
  scrollbar-width: thin;
  scrollbar-color: var(--secondary) #f1f1f1;
}

#chatbotMessages::-webkit-scrollbar {
  width: 6px;
}

#chatbotMessages::-webkit-scrollbar-track {
  background: #f1f1f1;
}

#chatbotMessages::-webkit-scrollbar-thumb {
  background-color: var(--secondary);
  border-radius: 6px;
}

@keyframes blink {
  0%, 100% { opacity: 0.2; }
  50% { opacity: 1; }
}
#chatbotContainer {
    transition: all 0.3s ease;
    border: 1px solid #ddd;
}

#chatbotMessages {
    scrollbar-width: thin;
    scrollbar-color: var(--secondary) #f1f1f1;
    background-color: white;
}

#chatbotMessages::-webkit-scrollbar {
    width: 6px;
}

#chatbotMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chatbotMessages::-webkit-scrollbar-thumb {
    background-color: var(--secondary);
    border-radius: 6px;
}

.chatbot-typing {
    display: inline-block;
}

.chatbot-typing span {
    height: 10px;
    width: 10px;
    background-color: #6c5ce7;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: blink 1.4s infinite both;
}

.chatbot-typing span:nth-child(2) {
    animation-delay: 0.2s;
}

.chatbot-typing span:nth-child(3) {
    animation-delay: 0.4s;
}

/* Header Group Colors */
.header-group-submission {
  background-color: #6c5ce7;
  color: white;
}

.header-group-dates {
  background-color: #00b894;
  color: white;
}

.header-group-remarks {
  background-color: #fd79a8;
  color: white;
}

.header-group-technical {
  background-color: #a29bfe;
  color: white;
}

.header-group-final {
  background-color: #fdcb6e;
  color: black;
}

@keyframes blink {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
}
  </style>
</head>
<body>
  
  <div class="form-container">
    
    <div class="form-header">
      <div class="header-logo">
        <!-- Add proper alt text and consider adding width/height -->
        <img src="A.jpg" alt="Archcorp Logo" width="0" height="60"  style=" width: 182%;">
      </div>
      <h2><i class="fas fa-project-diagram"></i>Authority Tracker</h2>
      <p>Fill out the form to submit your Authority Tracker Details</p>
      <div class="update-btn-container">
        <button type="button" class="update-btn" onclick="goToUpdatePage()">
          <i class="fas fa-edit"></i> Update Entries
        </button>
      </div>
    </div>
    <!--<form action="#" method="post" class="form-body">-->
      <form action="/submit" method="post" enctype="multipart/form-data" class="form-body">
      <!-- Basic Info Section -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label for="projectNumber">Project Number</label>
          <select id="projectNumberDropdown" name="projectNumber">
            <option value="">-- Please choose a project number --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="projectName">Project Name</label>
          <select id="projectDropdown" name="project">
          </select>
        </div>
        
        <div class="form-group">
          <label for="emirate">Emirate</label>
          <select id="emirate" name="emirate" required>
            <option value="">-- Select Emirate --</option>
            <option value="abu_dhabi">Abu Dhabi</option>
            <option value="dubai">Dubai</option>
            <option value="sharjah">Sharjah</option>
            <option value="ajman">Ajman</option>
            <option value="umm_al_quwain">Umm Al Quwain</option>
            <option value="ras_al_khaimah">Ras Al Khaimah</option>
            <option value="fujairah">Fujairah</option>
          </select>
        </div>
        <div class="form-group">
          <label for="authority">Authority</label>
          <select id="authority" name="authority" required>
            <option value="">-- Select Authority --</option>
            <option value="">-- Select Authority --</option>
            <option value="al-ain-civil-defense">Al Ain Civil Defense</option>
            <option value="al-ain-distribution-company">Al Ain Distribution Company</option>
            <option value="al-ain-municipality">Al Ain Municipality</option>
            <option value="abu-dhabi-airports-company">Abu Dhabi Airports Company</option>
            <option value="abu-dhabi-civil-defense">Abu Dhabi Civil Defense</option>
            <option value="abu-dhabi-distribution-company">Abu Dhabi Distribution Company</option>
            <option value="abu-dhabi-municipality">Abu Dhabi Municipality</option>
            <option value="abu-dhabi-sewerage-services-company">Abu Dhabi Sewerage Services Company</option>
            <option value="abu-dhabi-water-and-electricity-authority">Abu Dhabi Water and Electricity Authority</option>
            <option value="dubai-civil-aviation-authority">Dubai Civil Aviation Authority</option>
            <option value="dubai-civil-defense">Dubai Civil Defense</option>
            <option value="department-of-culture-and-tourism">Department of Culture and Tourism</option>
            <option value="dubai-development-authority">Dubai Development Authority</option>
            <option value="dewa">Dubai Electricity and Water Authority</option>
            <option value="dubai-health-authority">Dubai Health Authority</option>
            <option value="dubai-municipality">Dubai Municipality</option>
            <option value="department-of-transport">Department of Transport</option>
            <option value="dubai-south">Dubai South</option>
            <option value="dubai-silicon-oasis">Dubai Silicon Oasis</option>
            <option value="dubai-economy-and-tourism">Dubai Economy and Tourism</option>
            <option value="sharjah-town-planning">Sharjah Department of Town Planning and Survey</option>
            <option value="ead">Environmental Agency Abu Dhabi</option>
            <option value="empower">Emirates Central Cooling Systems Corporation</option>
            <option value="iacad">Islamic Affairs and Charitable Activities Department</option>
            <option value="itc">Integrated Transport Center</option>
            <option value="khda">Knowledge and Human Development Authority</option>
            <option value="mcc">Monitoring and Control Center</option>
            <option value="rta">Roads and Transport Authority</option>
            <option value="sewa">Sharjah Electricity and Water Authority</option>
            <option value="sira">Security Industry Regulatory Industry</option>
            <option value="sharjah-municipality">Sharjah Municipality</option>
            <option value="sharjah-rta">Sharjah Roads and Transport Authority</option>
            <option value="dbps">Dubai Building Permit System Portal</option>
            <option value="dmp">Dubai Municipality Planning Portal</option>
            <option value="meps">Municipal Electronic Permitting System</option>
            <option value="dld">Dubai Land Department</option>
            <option value="rera">Real Estate Regulatory Authority</option>
            <option value="fewa">Federal Electricity and Water Authority</option>
            <option value="adnoc">Abu Dhabi National Oil Company</option>
            <option value="dmt">Department of Municipal Affairs of Abu Dhabi</option>
            <option value="emaar">EMAAR</option>
            <option value="nakheel">NAKHEEL</option>
            <option value="dm-sewerage">DM Sewerage Department</option>
            <option value="etisalat">Etisalat</option>
            <option value="du">Du</option>
            <option value="tabreed">National Central Cooling Company PJSC</option>
            <option value="trakhees">TRAKHEES</option>
            <option value="master-developer">Master Developer</option>
            <option value="etisalat-du">Etisalat/Du</option>
            <option value="empower-tabreed">Empower or Tabreed</option>
            <option value="heritage-dept">Heritage Department</option>
            <option value="iacad-awfaq">IACAD/AWFAQ</option>
            <option value="smarthub">SmartHub Platform by DMT</option>
            <option value="moiscd">Ministry of Interior-SCD</option>
            <option value="wasl">Wasl</option>
            <option value="dusp">DUSUP</option>
            <option value="moiscd">Wasl</option>
            <option value="moiscd">Service Provider</option>
          </select>
        </div>
      </div>

      <!-- Submission Table Section -->
      <div class="data-table-wrapper">
        <table class="data-table" id="submissionTable">
          <thead>
            <tr class="header-row-1">
              <th rowspan="2" style="background-color: #32607e; color: white;">Submission Type</th>
    <th rowspan="2" style="background-color: #32607e; color: white;">Request No.</th>
    <th rowspan="2" style="background-color: #32607e  ; color: white;">Status</th>
    
    <!-- Group 2: Dates -->
    <th colspan="2" style="background-color: #6685a5; color: white;">Planned Dates</th>
    <th rowspan="2" style="background-color: #57818d; color: white;">Days Difference</th>
    <th colspan="2" style="background-color: #6685a5; color: white;">Actual Dates</th>
    
    <!-- Group 3: Remarks -->
    <th rowspan="2" style="background-color: #4c9450; color: white;">Authority Remarks</th>
    <th rowspan="2" style="background-color: #4c9450; color: white;">Action Remarks</th>
    
    <!-- Group 4: Technical -->
    <th rowspan="2" style="background-color: #9ba620; color: white;">Technical Comments</th>
    
    <!-- Group 5: Final Info -->
    <th rowspan="2" style="background-color: #e79899; color: black;">Client Informed?</th>
    <th rowspan="2" style="background-color: #e79899; color: black;">Sub Consultant</th>
    <th rowspan="2" style="background-color: #e79899; color: black;">Attachments</th>
  </tr>
  <tr class="header-row-2">
    <!-- Group 2 sub-headers -->
    <th style="background-color: #6685a5; color: white;">Submission</th>
    <th style="background-color: #6685a5; color: white;">Approval</th>
    <th style="background-color: #6685a5; color: white;">Submission</th>
    <th style="background-color: #6685a5; color: white;">Approval</th>
  </tr>
</thead>
          <tbody>
            <!-- Row appended via JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="button-container">
        <button type="button" onclick="addRow('submissionTable')" class="icon-btn" title="Add Submission">
          <i class="fas fa-plus-circle"></i>
        </button>
        <button type="button" onclick="deleteLastRow('submissionTable')" class="icon-btn" title="Remove Last Submission" style="color: var(--danger);">
          <i class="fas fa-minus-circle"></i>
        </button>
        <button type="button" class="icon-btn" onclick="toggleChatbot()" style="background: linear-gradient(to right, #0984e3, #74b9ff);">
          <i class="fas fa-robot"></i> Authority Assistant
        </button>
      </div>
      <div class="button-container">
        <button type="button" class="submit-btn" onclick="handleSubmit()">
          <i class="fas fa-check-circle"></i> Submit New Entry
        </button>
      </div>
      <div id="popupMessage" style="display:none; margin-top: 20px; padding: 15px; background: var(--success); color: white; font-weight: bold; border-radius: 8px; text-align: center;">
        Submission successful! Proceeding to next Authority and Emirate...
      </div>
    </form>
  </div>

  <script>
   function goToUpdatePage() {
  const projectNumber = document.querySelector('[name="projectNumber"]').value;
  const emirate = document.querySelector('[name="emirate"]').value;
  const authority = document.querySelector('[name="authority"]').value;
  
  if (!projectNumber) {
    alert('Please select a project number first');
    return;
  }
  
  window.location.href = `update.html?projectNumber=${encodeURIComponent(projectNumber)}&emirate=${encodeURIComponent(emirate)}&authority=${encodeURIComponent(authority)}`;
}
async function handleSubmit() {
    try {
        const formData = new FormData();
        
        // Add basic form data
        formData.append('projectName', document.querySelector('[name="project"]').value);
        formData.append('projectNumber', document.querySelector('[name="projectNumber"]').value);
        formData.append('emirate', document.querySelector('[name="emirate"]').value);
        formData.append('authority', document.querySelector('[name="authority"]').value);

        // Process each submission row
        const rows = document.querySelectorAll('#submissionTable tbody tr');
        rows.forEach((row, index) => {
            // Get all input values from the row
            const inputs = row.querySelectorAll('input:not([type="file"]), select, textarea');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    // Only add radio button if it's checked
                    if (input.checked) {
                        const name = input.name.replace(/_\d+$/, '');
                        formData.append(`submissions[${index}].${name}`, input.value);
                    }
                } else if (input.type !== 'file') {
                    const name = input.name.replace(/_\d+$/, '');
                    formData.append(`submissions[${index}].${name}`, input.value);
                }
            });

            // Handle file uploads
            const fileInput = row.querySelector('input[type="file"]');
            if (fileInput && fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(file => {
                    formData.append(`submissions[${index}].attachments`, file);
                });
            }
        });

        // Show loading state
        const submitBtn = document.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        const response = await fetch('/submit', {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }

        const data = await response.json();
        
        // Show success message
        const popup = document.getElementById('popupMessage');
        popup.style.display = 'block';
        popup.textContent = `Submission successful! ${data.count} records created.`;
        popup.scrollIntoView({ behavior: 'smooth' });

        // Reset form after delay
        setTimeout(() => {
            popup.style.display = 'none';
            document.querySelector('form').reset();
            const table = document.querySelector('#submissionTable tbody');
            table.innerHTML = '';
            addRow('submissionTable');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Entry';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 3000);
    } catch (error) {
        console.error('Submission error:', error);
        alert(`Submission failed. Please check:\n1. Backend is running\n2. No CORS errors\n3. Correct URL`);
        document.querySelector('.submit-btn').disabled = false;
        document.querySelector('.submit-btn').innerHTML = '<i class="fas fa-check-circle"></i> Submit Entry';
    }
}
async function handleUpdate() {
  try {
    const formData = new FormData();
    formData.append('projectName', document.querySelector('[name="project"]').value);
    formData.append('projectNumber', document.querySelector('[name="projectNumber"]').value);
    formData.append('emirate', document.querySelector('[name="emirate"]').value);
    formData.append('authority', document.querySelector('[name="authority"]').value);

    const rows = document.querySelectorAll('#submissionTable tbody tr');
    rows.forEach((row, index) => {
      const inputs = row.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        const name = input.name.replace(/_\d+$/, '');
        if (input.type !== 'file') {
          formData.append(`submissions[${index}].${name}`, input.value);
        }
      });

      const fileInput = row.querySelector('input[type="file"]');
      if (fileInput && fileInput.files.length > 0) {
        Array.from(fileInput.files).forEach(file => {
          formData.append(`submissions[${index}].attachments`, file);
        });
      }
    });

    const response = await fetch('/update', {
      method: 'POST',
      body: formData,
      headers: {
        'Accept': 'application/json'
      }
    });

    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
      const text = await response.text();
      console.error('Unexpected non-JSON response:', text);
      alert('Update failed: Server did not return valid JSON.');
      return;
    }

    const result = await response.json();
    alert(`Update successful: ${result.updated} records updated.`);
  } catch (err) {
    console.error('Update error:', err);
    alert('Update failed: ' + err.message);
  }
}

function calculateDaysDifference(row) {
  const plannedSubDate = row.querySelector('input[name="plannedSubmissionDate"]').value;
  const plannedAppDate = row.querySelector('input[name="plannedApprovalDate"]').value;
  const hiddenInput = row.querySelector('input[name^="daysDifference_"]');
  
  if (plannedSubDate && plannedAppDate) {
    const date1 = new Date(plannedSubDate);
    const date2 = new Date(plannedAppDate);
    const diffTime = Math.abs(date2 - date1);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    row.querySelector('.days-difference').textContent = diffDays + " days";
    if (hiddenInput) hiddenInput.value = diffDays;
  } else {
    row.querySelector('.days-difference').textContent = "";
    if (hiddenInput) hiddenInput.value = "";
  }
}

    function setupDateListeners(row) {
      row.querySelector('input[name="plannedSubmissionDate"]').addEventListener('change', () => calculateDaysDifference(row));
      row.querySelector('input[name="plannedApprovalDate"]').addEventListener('change', () => calculateDaysDifference(row));
    }
    
    function deleteLastRow(tableId) {
  const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
  const rows = table.getElementsByTagName('tr');
  
  if (rows.length > 0) {
    table.removeChild(rows[rows.length - 1]);
  } else {
    alert('No rows to delete!');
  }
}
    function addRow(tableId) {
      const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
      const uniqueId = Date.now();
      let newRow = document.createElement('tr');
      newRow.innerHTML = `
<td>
  <input type="text" name="submissionType" list="submissionTypes" placeholder="Type or select submission type" required>
  <datalist id="submissionTypes">
    <optgroup label="Application">
      <option value="Load Demand Notification - Electrical">
      <option value="NOI - Request for GIS Information">
      <option value="NOI - Request for GIS Information (If applicable)">
      <option value="Request for Exceptions (if any)">
      <option value="Soil Investigation Request">
      <option value="Site Services Information Request">
      <option value="Project Registration">
      <option value="Project Registration (through Trakhees)">
    </optgroup>
    
    <optgroup label="Permit">
      <option value="Building Permit Issuance">
      <option value="Excavation Permit">
      <option value="Piling Permit">
      <option value="Mobilization Permit">
      <option value="Advertising Permit">
      <option value="Modification/Adjustment Permit">
      <option value="Building Permit (Revision / Amendment)">
      <option value="Soil Investigation Work Permit">
    </optgroup>
    
    <optgroup label="Approval">
      <option value="DCD Final Approval">
      <option value="Detailed Design Approval (Building Permit)">
      <option value="Third Party Building Survey Review">
      <option value="Soil Report Review">
      <option value="Shoring Design Approval">
      <option value="Piling Design Approval">
      <option value="Post-Tension Design Approval">
      <option value="Preliminary Design Approval">
      <option value="DEWA - Electrical NOC - LV/HV Approval">
      <option value="DEWA - Water NOC">
      <option value="DEWA - Electrical NOC">
      <option value="DEWA - Electrical NOC - HV/LV">
      <option value="EHS Approval">
      <option value="FIC Approval">
      <option value="Sewerage / Drainage Approval">
      <option value="Dewa - HV (if applicable)">
      <option value="Auto TIS Assessment">
      <option value="RTA Gate Level NOC">
      <option value="Modification/Adjustment Approval">
      <option value="HSE NOC for BP">
      <option value="District Cooling Approval">
      <option value="Structural Inspections">
      <option value="Sewerage/Drainage Approval">
      <option value="Sewerage Connection Confirmation">
      <option value="Electrical Load Confirmation Letter">
      <option value="Affection Plan & Planning Conditions Statement">
      <option value="Plot Demarcation Study">
      <option value="Initial Designs Approval">
      <option value="EIA Approval (if required)">
      <option value="ETS Room NOC (if applicable)">
      <option value="ETS Room NOI">
      <option value="ETS Room NOI (if applicable)">
      <option value="ETS Room NOC">
      <option value="District Cooling NOC">
      <option value="Islamic Affairs Approval (in case of Mosque)">
      <option value="TIS Approval (Circulation Plan)">
      <option value="CCTV Drawings Approval">
      <option value="RTA Information NOC (if there is no master developer)">
      <option value="RTA Access Design NOC">
      <option value="RTA Temporary Fencing and Signboard NOC">
      <option value="FIC Approval (via RTA Information NOC)">
      <option value="Studying Access Design NOC">
      <option value="Studying Design Access NOC">
      <option value="TIS Approval">
      <option value="RTA Information NOC">
      <option value="RTA Preliminary Design Approval">
      <option value="Electrical Approval">
      <option value="Water Approval">
      <option value="Natural Gas Approval">
      <option value="Engineering Drawings Approval">
      <option value="Access Approval (if required)">
      <option value="DCD Revision">
      <option value="Drainage Revision">
      <option value="Telecom NOC - Etisalat/Du">
      <option value="Swimming Pool Approval (if applicable)">
      <option value="Site Approval and Clearances">
      <option value="Traffic Study Review (Circulation Plan)">
      <option value="Architecture Harmony Approval">
      <option value="Circulation Plan Approval">
      <option value="Concept Design">
      <option value="Parking Exit and Entry">
      <option value="Civil Defense Drawings Approval">
      <option value="Structural Drawings Approval">
      <option value="Final Architecture Drawings Approval">
      <option value="MCC Drawings Approval">
      <option value="Approval from the Environmental Agency">
      <option value="Electrical Drawings Approval">
      <option value="Estidama Approval (if required)">
      <option value="Sewerage/Drainage Approval (Plumbing Drawings Approval)">
      <option value="Plumbing Drawings Approval">
      <option value="Etisalat Drawings Approval">
      <option value="Gas Approval (by House of Expertise)">
      <option value="Redemarcation NOC">
      <option value="Sewerage Design NOC">
      <option value="Exceptions NOC (if applicable)">
      <option value="Dewatering NOC (if required)">
      <option value="Infrastructure Plot Details Information">
      <option value="Plot Access and Curb Cut NOC">
      <option value="Transfer Design Approval NOC">
      <option value="Detailed Design Approval (Building Permit - Amendment)">
      <option value="FIC Approval (Sewerage NOC)">
      <option value="Shoring/Piling NOC (if required)">
      <option value="Sustainability Site Report">
      <option value="Soil Investigation NOC">
      <option value="Initial Demarcation NOC">
      <option value="Gate Level NOC">
      <option value="Heritage Dept. Approval/NOC (if applicable)">
      <option value="IACAD/AWFAQ NOC and approved drawings (if Mosque)">
      <option value="LEED Certification/Approval (if applicable)">
      <option value="Developer Approval">
      <option value="Topographic Survey">
      <option value="Plot Setting Out Study">
      <option value="Plot Setting Out Study (If applicable)">
      <option value="Civil Defense Approval">
    </optgroup>
    
    <optgroup label="Renewal">
      <option value="Renew Expired Approval">
      <option value="Renew Expired Design">
      <option value="Expired Building Permit - Revalidation">
      <option value="Green Building Certification (Re-validation)">
    </optgroup>
  </datalist>
</td>
        <td><input type="text" name="requestNo"></td>
        <td>
          <select name="submissionStatus">
            <option value="">-- Select --</option>
            <option value="Open">Open</option>
            <option value="Approved with Comments">Approved with Comments</option>
            <option value="Objection">Objection</option>
            <option value="Consultant For Review">Consultant For Review</option>
            <option value="Pending approval by Consultant">Pending approval by Consultant</option>
            <option value="Submitted">Submitted</option>
            <option value="In Review">In Review</option>
            <option value="Resubmitted">Resubmitted</option>
            <option value="Revision In Progress">Revision In Progress</option>
            <option value="FFI by Consultant">FFI by Consultant</option>
            <option value="RFI by EDC Admin">RFI by EDC Admin</option>
            <option value="Pending for Resubmission">Pending for Resubmission</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
        </td>
        <td><input type="date" name="plannedSubmissionDate"></td>
        <td><input type="date" name="plannedApprovalDate"></td>
        <td class="days-difference"></td>
        <input type="hidden" name="daysDifference_${uniqueId}" value="">
        <td><input type="date" name="actualSubmissionDate"></td>
        <td><input type="date" name="actualApprovalDate"></td>
        <td><textarea name="authorityRemarks" placeholder="Authority Remarks"></textarea></td>
        <td><textarea name="actionRemark" placeholder="Action Remarks"></textarea></td>
        <td><textarea name="technicalComments" placeholder="Technical Comments"></textarea></td>
<td>
  <div class="radio-group">
    <div class="radio-option">
      <input type="radio" id="clientInformedYes_${uniqueId}" 
             name="clientInformed_${uniqueId}" 
             value="Yes">
      <label for="clientInformedYes_${uniqueId}">Yes</label>
    </div>
    <div class="radio-option">
      <input type="radio" id="clientInformedNo_${uniqueId}" 
             name="clientInformed_${uniqueId}" 
             value="No" checked>
      <label for="clientInformedNo_${uniqueId}">No</label>
    </div>
  </div>
</td>   
<td><input type="text" name="subConsultant"></td>
        <td>
          <label for="file_${uniqueId}" class="submit-btn" style="padding: 6px 10px; font-size: 14px; cursor: pointer; width: auto;">
            <i class="fas fa-paperclip"></i> Attach
          </label>
          <input type="file" id="file_${uniqueId}" name="attachments[]" multiple style="display: none;" />
        </td>
      `;
      table.appendChild(newRow);
      setupDateListeners(newRow);
    }

    window.onload = () => addRow('submissionTable'); // Load first row on page load
    window.onload = async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const projectNumber = urlParams.get('projectNumber');

  if (projectNumber) {
    document.querySelector('[name="projectNumber"]').value = projectNumber;
    await loadExistingData(projectNumber);
  } else {
    addRow('submissionTable'); // Fallback if no existing project number
  }
};

async function loadExistingData(projectNumber) {
  try {
    const response = await fetch(`/get-submissions?projectNumber=${projectNumber}`);
    const data = await response.json();
    const table = document.getElementById('submissionTable').getElementsByTagName('tbody')[0];
    table.innerHTML = ''; // clear existing

    data.forEach((entry, index) => {
      const uniqueId = Date.now() + index;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><select name="submissionType"><option value="">-- Select --</option><option value="application">Application</option><option value="permit">Permit</option><option value="approval">Approval</option><option value="renewal">Renewal</option></select></td>
        <td><input type="text" name="requestNo" value="${entry.requestNo || ''}"></td>
        <td>
          <select name="submissionStatus">
            ${generateStatusOptions(entry.submissionStatus)}
          </select>
        </td>
        <td><input type="date" name="plannedSubmissionDate" value="${formatDate(entry.plannedSubmissionDate)}"></td>
        <td><input type="date" name="plannedApprovalDate" value="${formatDate(entry.plannedApprovalDate)}"></td>
        <td class="days-difference">${entry.daysDifference || ''}</td>
        <input type="hidden" name="submissions[${uniqueId}].daysDifference" value="${entry.daysDifference || ''}">
        <input type="hidden" name="submissions[${uniqueId}].recordId" value="${entry.id}">
        <td><input type="date" name="actualSubmissionDate" value="${formatDate(entry.actualSubmissionDate)}"></td>
        <td><input type="date" name="actualApprovalDate" value="${formatDate(entry.actualApprovalDate)}"></td>
        <td><textarea name="authorityRemarks">${entry.authorityRemarks || ''}</textarea></td>
        <td><textarea name="actionRemark">${entry.actionRemark || ''}</textarea></td>
        <td><textarea name="technicalComments">${entry.technicalComments || ''}</textarea></td>
        <td>
          <div class="radio-group">
            <div class="radio-option"><input type="radio" id="clientInformedYes_${uniqueId}" name="clientInformed_${uniqueId}" value="Yes" ${entry.clientInformed ? 'checked' : ''}><label for="clientInformedYes_${uniqueId}">Yes</label></div>
            <div class="radio-option"><input type="radio" id="clientInformedNo_${uniqueId}" name="clientInformed_${uniqueId}" value="No" ${!entry.clientInformed ? 'checked' : ''}><label for="clientInformedNo_${uniqueId}">No</label></div>
          </div>
        </td>
        <td><input type="text" name="subConsultant" value="${entry.subConsultant || ''}"></td>
        <td>
          <label for="file_${uniqueId}" class="submit-btn" style="padding: 6px 10px; font-size: 14px; cursor: pointer; width: auto;">
            <i class="fas fa-paperclip"></i> Attach
          </label>
          <input type="file" id="file_${uniqueId}" name="attachments[]" multiple style="display: none;" />
        </td>
      `;
      table.appendChild(row);
      setupDateListeners(row);
      calculateDaysDifference(row);
    });
  } catch (err) {
    console.error('Load failed:', err);
    alert('Failed to load existing data.');
  }
}

function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toISOString().split('T')[0];
}

function generateStatusOptions(selected) {
  const options = [
    "Open", "Approved with Comments", "Objection", "Consultant For Review",
    "Pending approval by Consultant", "Submitted", "In Review", "Resubmitted",
    "Revision In Progress", "FFI by Consultant", "RFI by EDC Admin",
    "Pending for Resubmission", "Approved"
  ];
  return options.map(opt => `<option value="${opt}" ${selected === opt ? 'selected' : ''}>${opt}</option>`).join('');
}

function goToUpdatePage() {
  window.location.href = "update.html";
}

let projectMapping = {};

async function loadProjectMapping() {
  try {
    const response = await fetch('/get-project-mapping');
    projectMapping = await response.json();
    setupProjectNumberListener();
  } catch (error) {
    console.error('Error loading project mapping:', error);
  }
}

// Set up event listener for project number selection
function setupProjectNumberListener() {
  const projectNumberSelect = document.getElementById('projectNumber');
  const projectNameInput = document.getElementById('projectName');
  
  projectNumberSelect.addEventListener('change', function() {
    const selectedNumber = this.value;
    if (selectedNumber && projectMapping[selectedNumber]) {
      projectNameInput.value = projectMapping[selectedNumber];
    } else {
      projectNameInput.value = '';
    }
  });
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load first row
    addRow('submissionTable');
    
    // Check for existing project number
    const urlParams = new URLSearchParams(window.location.search);
    const projectNumber = urlParams.get('projectNumber');
    
    if (projectNumber) {
        document.querySelector('[name="projectNumber"]').value = projectNumber;
        loadExistingData(projectNumber);
    }
    
    // Load project mapping
    loadProjectMapping();
    
    // Setup chatbot button
    document.querySelector('.icon-btn[onclick="toggleChatbot()"]')
        .addEventListener('click', function(e) {
            e.preventDefault();
            toggleChatbot();
        });
});
function toggleChatbot() {
    const chatbot = document.getElementById('chatbotContainer');
    if (!chatbot) return;
    
    chatbot.style.display = chatbot.style.display === 'none' ? 'block' : 'none';
    if (chatbot.style.display === 'block') {
        document.getElementById('chatbotInput').focus();
    }
}

function addChatMessage(message, isUser = false) {
    const messagesContainer = document.getElementById('chatbotMessages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '10px';
    messageDiv.style.padding = '8px 12px';
    messageDiv.style.borderRadius = '5px';
    messageDiv.style.wordBreak = 'break-word';
    
    if (isUser) {
        messageDiv.style.background = '#e3f2fd';
        messageDiv.style.marginLeft = '20px';
        messageDiv.innerHTML = `<strong>ðŸ§‘ You:</strong> ${message}`;
    } else {
        messageDiv.style.background = '#f1f1f1';
        messageDiv.innerHTML = `<strong>ðŸ¤– Assistant:</strong> ${message}`;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function sendChatbotMessage() {
    const input = document.getElementById('chatbotInput');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;
    
    // Add user message to chat
    addChatMessage(message, true);
    input.value = '';
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message // Only sending the message now
            })
        });
        
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        
        const { reply } = await response.json();
        addChatMessage(reply);
        
    } catch (error) {
        console.error('Chat error:', error);
        addChatMessage("Sorry, I'm having trouble connecting to the assistant. Please try again later.");
    }
}

window.onload = async () => {
  // Load projects from database
  await loadProjects();
  
  // Check for existing project number in URL
  const urlParams = new URLSearchParams(window.location.search);
  const projectNumber = urlParams.get('projectNumber');

  if (projectNumber) {
    document.querySelector('[name="projectNumber"]').value = projectNumber;
    await loadExistingData(projectNumber);
  } else {
    addRow('submissionTable'); // Fallback if no existing project number
  }
};

// Add this new function to load projects
async function loadProjects() {
  try {
    // Show loading state
    document.getElementById('projectDropdown').disabled = true;
    document.getElementById('projectNumberDropdown').disabled = true;
    
    const response = await fetch('/get-projects');
    
    if (!response.ok) {
  const contentType = response.headers.get('content-type');
  let errorMsg = `Server returned ${response.status}`;

  if (contentType && contentType.includes('application/json')) {
    const errorData = await response.json();
    errorMsg = errorData.error || errorMsg;
  } else {
    const errorText = await response.text(); // fallback to plain text
    console.error('Non-JSON error response:', errorText);
  }

  throw new Error(errorMsg);
}
    
    const projects = await response.json();
    
    if (!projects || projects.length === 0) {
      throw new Error('No projects found in database');
    }

    const projectDropdown = document.getElementById('projectDropdown');
    const projectNumberDropdown = document.getElementById('projectNumberDropdown');
    
    // Clear existing options except first
    projectDropdown.innerHTML = '<option value="">-- Please choose a project --</option>';
    projectNumberDropdown.innerHTML = '<option value="">-- Please choose a project number --</option>';

    projects.forEach(project => {
      // Add to project name dropdown
      const option1 = document.createElement('option');
      option1.value = project.projectName;
      option1.textContent = project.projectName;
      projectDropdown.appendChild(option1);
      
      // Add to project number dropdown
      const option2 = document.createElement('option');
      option2.value = project.projectNumber;
      option2.textContent = project.projectNumber;
      projectNumberDropdown.appendChild(option2);
    });
    
    // Set up the mapping between project numbers and names
    setupProjectMapping(projects);
    
  } catch (err) {
    console.error('Error loading projects:', err);
    alert(`Failed to load projects: ${err.message}\n\nPlease check:
    1. Backend server is running
    2. Database connection is working
    3. A_Project table exists with P_id and Description columns`);
  } finally {
    document.getElementById('projectDropdown').disabled = false;
    document.getElementById('projectNumberDropdown').disabled = false;
  }
}
// Add this function to handle the mapping
function setupProjectMapping(projects) {
  const projectNameSelect = document.getElementById('projectDropdown');
  const projectNumberSelect = document.getElementById('projectNumberDropdown');
  
  // When project name changes, update project number
  projectNameSelect.addEventListener('change', function() {
    const selectedProject = projects.find(p => p.projectName === this.value);
    if (selectedProject) {
      projectNumberSelect.value = selectedProject.projectNumber;
    }
  });
  
  // When project number changes, update project name
  projectNumberSelect.addEventListener('change', function() {
    const selectedProject = projects.find(p => p.projectNumber === this.value);
    if (selectedProject) {
      projectNameSelect.value = selectedProject.projectName;
    }
  });
}
// Make sure the chatbot button works
document.querySelector('.icon-btn[onclick="toggleChatbot()"]').addEventListener('click', function(e) {
    e.preventDefault();
    toggleChatbot();
});

  </script>
  <div id="chatbotContainer" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 350px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000;">
    <div style="background: #6c5ce7; color: white; padding: 15px; border-top-left-radius: 10px; border-top-right-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 16px;">Authority Assistant</h3>
        <button onclick="toggleChatbot()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">&times;</button>
    </div>
    <div id="chatbotMessages" style="height: 300px; overflow-y: auto; padding: 15px; font-size: 14px;">
        <div style="margin-bottom: 10px; padding: 8px 12px; background: #f1f1f1; border-radius: 5px;">
            <strong>ðŸ¤– Authority Assistant:</strong> Welcome! I can help you with submission statuses, requirements, and authority processes. How can I assist you today?
        </div>
    </div>
    <div style="padding: 15px; border-top: 1px solid #eee; display: flex;">
        <input type="text" id="chatbotInput" placeholder="Ask about submissions..." 
               style="flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
               onkeypress="if(event.key === 'Enter') sendChatbotMessage()">
        <button onclick="sendChatbotMessage()" 
                style="margin-left: 10px; padding: 10px 15px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
</body>
</html>